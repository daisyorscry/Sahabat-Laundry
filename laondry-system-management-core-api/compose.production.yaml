x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: "50m"
    max-file: "10"
    compress: "true"

x-healthcheck: &default-healthcheck
  interval: 1s
  retries: 10
  timeout: 3s

services:
  app:
    build:
      context: .
      dockerfile: Swoole.Dockerfile
      args:
        USER_ID: ${HOST_UID:-1000}
        GROUP_ID: ${HOST_GID:-1000}
    image: 'laravel/app:latest'
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    env_file:
      - .env
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    security_opt:
      - no-new-privileges:true
    networks:
      - stack
    ports:
      - "8000:8000"
    volumes:
      - './storage/app/public:/var/www/html/storage/app/public'
      - './storage/logs:/var/www/html/storage/logs'
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "--fail", "--max-time", "10", "localhost:8000"]
      <<: *default-healthcheck

  pgsql:
    image: 'postgres:${POSTGRES_VERSION:-17}-alpine'
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    security_opt:
      - no-new-privileges:true
    environment:
      PGPASSWORD: '${DB_PASSWORD}'
      POSTGRES_DB: '${DB_DATABASE}'
      POSTGRES_USER: '${DB_USERNAME}'
      POSTGRES_PASSWORD: '${DB_PASSWORD}'
    volumes:
      - 'stack-pgsql:/var/lib/postgresql/data'
      - '../backup:/backup'
    networks:
      - stack
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      <<: *default-healthcheck
    restart: unless-stopped
    logging: *default-logging

  pgbouncer:
    image: bitnamilegacy/pgbouncer:latest
    restart: unless-stopped
    logging: *default-logging
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    security_opt:
      - no-new-privileges:true
    depends_on:
      pgsql:
        condition: service_healthy
    environment:
      POSTGRESQL_HOST: pgsql
      POSTGRESQL_PORT: 5432
      PGBOUNCER_PORT: 6432
      PGBOUNCER_DATABASE: '${DB_DATABASE}'
      POSTGRESQL_USERNAME: '${DB_USERNAME}'
      POSTGRESQL_PASSWORD: '${DB_PASSWORD}'
      PGBOUNCER_POOL_MODE: session
      PGBOUNCER_AUTH_TYPE: md5
      PGBOUNCER_MAX_CLIENT_CONN: 500
      PGBOUNCER_DEFAULT_POOL_SIZE: 25
      PGBOUNCER_USERLIST: '"${DB_USERNAME}" "${DB_PASSWORD}"'
    networks:
      - stack
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 6432 -U ${DB_USERNAME}"]
      <<: *default-healthcheck

  redis:
    image: 'redis:7-alpine'
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    command: [
      "redis-server",
      "--requirepass", "${REDIS_PASSWORD}",
      "--maxmemory", "${REDIS_MAXMEMORY:-512mb}",
      "--maxmemory-policy", "allkeys-lru",
      "--save", "900 1",
      "--save", "300 10",
      "--save", "60 10000"
    ]
    security_opt:
      - no-new-privileges:true
    volumes:
      - 'stack-redis:/data'
    networks:
      - stack
    logging: *default-logging
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
      <<: *default-healthcheck
    restart: unless-stopped

networks:
  stack:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450

volumes:
  stack-pgsql:
    driver: local
  stack-redis:
    driver: local
